<!DOCTYPE html>
<html>
<head>
	<title>Minesweeper</title>
	<style type="text/css"> 
		body {
			line-height: 0;
		}
	</style>
</head>
<body>

<button onclick="newGame(width, height)">hi</button>
<br>

<script>

// Build a multidimensional array
var width = 29;
var height = 15;
var board = [];
newGame(29, 15);

function newGame (width, height) {

	deleteBoard(board);

	var num_bombs = 0;

	for (var a = 0; a<height; a++) {
		board[a] = [];
		for (var b = 0; b<width; b++) {
			var image = document.createElement("img");
			image.id = a + ":" + b;
			image.src = "images/unknown.png";
			image.width = "20";
			image.height = "20";
			image.onclick = onclick;
			image.attr_type = 0;
			image.oncontextmenu = onclick;
			if (Math.floor(Math.random() * 5) == 0) { // One in ten odds
				image.attr_type = "bomb";
				num_bombs ++;
			}
			board[a][b] = image;
			document.body.appendChild(board[a][b]);
		}
		var br = document.createElement("br");
		document.body.appendChild(br);
	}

	console.log(num_bombs);

	for (var a = 0; a<height; a++) {
		for (var b = 0; b<width; b++) {
			var square = board[a][b];
			if (square.attr_type === "bomb"){
	//			Check the edges
				incrementSquare(a - 1, b);
				incrementSquare(a + 1, b);
				incrementSquare(a, b - 1);
				incrementSquare(a, b + 1);
	//			Check the corners
				incrementSquare(a - 1, b - 1);
				incrementSquare(a + 1, b + 1);
				incrementSquare(a - 1, b + 1);
				incrementSquare(a + 1, b - 1);
			}
		}
	}
}

function incrementSquare (a, b) {
	if (board[a] !== undefined) {
		if (board[a][b] !== undefined){
			if (board[a][b].attr_type !== "bomb") {
				board[a][b].attr_type ++;
			}
		}
	}
}

function onclick (e) {
	var unRegex = /unknown\.png/;
	var flRegex = /flag\.png/;
	var boRegex = /bomb\.png/;


	if (e.button == 0) { // Left click
		revealSquare(e.target);
	} else { // Right click
		if (e.target.src.match(unRegex)) {
			e.target.src = "images/flag.png";
		} else if (e.target.src.match(flRegex)) {
			e.target.src = "images/unknown.png";
		}
	}
	return false; // To prevent the context menu from appearing
}

function revealSquare (target) {
	if (target == undefined) {
		return;
	}
	if (target.src.match(/flag\.png/)) {
		return;
	}
	if (target.attr_type == "bomb") {
		target.src = "images/bomb.png";
//		gameOver();
		return;
	}
	if (!(target.src.match(/unknown\.png/))) {
		return;
	}
	if (target.attr_type == 0) {

		var id = target.id;
		var ids = id.split(":");
		var a = parseInt(ids[0]);
		var b = parseInt(ids[1]);
		var foo = "";
		var squareToReveal = "";

		target.src = "images/0.png";

		revealSquare(document.getElementById((a - 1) + ":" + b));
		revealSquare(document.getElementById((a + 1) + ":" + b));
		revealSquare(document.getElementById(a + ":" + (b - 1)));
		revealSquare(document.getElementById(a + ":" + (b + 1)));

		revealSquare(document.getElementById((a - 1) + ":" + (b - 1)));
		revealSquare(document.getElementById((a + 1) + ":" + (b + 1)));
		revealSquare(document.getElementById((a - 1) + ":" + (b + 1)));
		revealSquare(document.getElementById((a + 1) + ":" + (b - 1)));
		return;
	}
	if (target.attr_type > 0 && target.attr_type < 9) {
		target.src = "images/" + target.attr_type + ".png";
		return;
	}
}

function deleteBoard (board) {
	for (var row of board) {
		for (var square of row) {
			console.log(square.Id);
			square.parentNode.removeChild(square);
		}
	}
}

</script>
</body>
</html>